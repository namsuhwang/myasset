<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.idlelife.myasset.repository.MemberMapper">

    <select id="createMemberId" resultType="Long">
        SELECT IFNULL(MAX(member_id), 0) + 1 AS member_id
        FROM member
    </select>

    <insert id="insertMember" parameterType="MemberEntity">
            INSERT member (
                    member_id
                    ,member_name
                    ,email
                    ,pwd
                    ,birth_year
                    ,birth_month
                    ,birth_day
                    ,gender
                    ,delete_yn
                    ,reg_datetime
                    ,last_update_datetime
            ) VALUES
            (
                ${memberId}
                ,#{memberName}
                ,#{email}
                ,#{pwd}
                ,#{birthYear}
                ,#{birthMonth}
                ,#{birthDay}
                ,#{gender}
                ,#{deleteYn}
                ,NOW()
                ,NOW()
            )
    </insert>

    <update id="updateMember" parameterType="MemberEntity">
            UPDATE member
               SET
                  member_name   = #{memberName}
                 ,email         = #{email}
                 ,pwd           = #{pwd}
                 ,birth_year    = #{birthYear}
                 ,birth_month   = #{birthMonth}
                 ,birth_day     = #{birthDay}
                 ,gender        = #{gender}
                 ,delete_yn     = #{deleteYn}
                 ,last_update_datetime = NOW()
            WHERE member_id = ${memberId}
    </update>

    <delete id="deleteMember" parameterType="Long">
            UPDATE member
            SET
               delete_yn = 'Y'
              ,last_update_datetime = NOW()
            WHERE member_id = ${memberId}
    </delete>

    <select id="selectMember" parameterType="Long" resultType="MemberEntity">
            SELECT
                member_id
                 ,member_name
                 ,email
                 ,pwd
                 ,birth_year
                 ,birth_month
                 ,birth_day
                 ,gender
                 ,delete_yn
                 ,reg_datetime
                 ,last_update_datetime
            FROM member
            WHERE member_id = ${memberId}
    </select>

    <select id="selectMemberDto" parameterType="MemberSearch" resultType="MemberDto">
            SELECT
                member_id
                 ,member_name
                 ,email
                 ,pwd
                 ,CONCAT(birth_year, '-',  birth_month, '-',  birth_day) AS birth
                 ,gender
            FROM member
            WHERE delete_yn != 'Y'
            <if test = 'memberId != null and memberId !=""'>
                AND member_id = ${memberId}
            </if>
            <if test = 'memberName != null and memberName !=""'>
                AND member_name = #{memberName}
            </if>
            <if test = 'deleteYn != null and deleteYn !=""'>
                AND delete_yn = #{deleteYn}
            </if>
            <if test = 'email != null and email !=""'>
                AND email = #{email}
            </if>
    </select>

    <select id="selectMemberDtoList" parameterType="MemberSearch" resultType="MemberDto">
            SELECT
                member_id
                ,member_name
                ,email
                ,pwd
                ,CONCAT(birth_year, '-',  birth_month, '-',  birth_day) AS birth
                ,gender
            FROM member
            WHERE 1 = 1
              <if test = 'memberName != null and memberName !=""'>
                    AND member_name LIKE CONCAT('%', #{memberName}, '%')
              </if>
            <if test = 'deleteYn != null and deleteYn !=""'>
                AND delete_yn = #{deleteYn}
            </if>
              <if test = 'email != null and email !=""'>
                    AND email LIKE CONCAT('%', #{email}, '%')
              </if>
    </select>

    <insert id="insertMemberRole" parameterType="MemberRoleEntity">
        INSERT member_role (
            member_id
            ,role_cd
            ,delete_yn
            ,reg_datetime
            ,last_update_datetime
        ) VALUES
        (
        ${memberId}
        ,#{roleCd}
        ,#{deleteYn}
        ,NOW()
        ,NOW()
        )
    </insert>

    <delete id="deleteMemberRole" parameterType="MemberTokenEntity">
        UPDATE member_role
        SET
            delete_yn = 'Y'
          ,last_update_datetime = NOW()
        WHERE  member_id = ${memberId}
          AND  role_cd = #{roleCd}
    </delete>


    <select id="selectMemberRoleList" parameterType="MemberSearch" resultType="MemberRoleEntity">
        SELECT
        r.member_id
        ,r.role_cd
        ,r.delete_yn
        ,r.reg_datetime
        ,r.last_update_datetime
        FROM member_role r
        INNER JOIN member m ON m.member_id = r.member_id
        WHERE 1 = 1
        <if test = 'memberId != null and memberId !=""'>
            AND r.member_id = ${memberId}
        </if>
        <if test = 'memberName != null and memberName !=""'>
            AND m.member_name = #{memberName}
        </if>
        <if test = 'deleteYn != null and deleteYn !=""'>
            AND r.delete_yn = #{deleteYn}
        </if>
        <if test = 'email != null and email !=""'>
            AND m.email = #{email}
        </if>
    </select>

    <select id="selectMemberRole" parameterType="MemberSearch" resultType="MemberRoleEntity">
        SELECT
        r.member_id
        ,r.role_cd
        ,r.delete_yn
        ,r.reg_datetime
        ,r.last_update_datetime
        FROM member_role r
        INNER JOIN member m ON m.member_id = r.member_id
        WHERE 1 = 1
        <if test = 'memberId != null and memberId !=""'>
            AND r.member_id = ${memberId}
        </if>
        <if test = 'memberName != null and memberName !=""'>
            AND m.member_name = #{memberName}
        </if>
        <if test = 'deleteYn != null and deleteYn !=""'>
            AND r.delete_yn = #{deleteYn}
        </if>
        <if test = 'email != null and email !=""'>
            AND m.email = #{email}
        </if>
    </select>


    <insert id="insertMemberToken" parameterType="MemberTokenEntity">
        INSERT member_token (
            member_id
            ,refresh_token
            ,refresh_token_expire_datetime
            ,delete_yn
            ,reg_datetime
            ,last_update_datetime
        ) VALUES
        (
        ${memberId}
        ,#{refreshToken}
        ,#{refreshTokenExpireDatetime}
        ,#{deleteYn}
        ,NOW()
        ,NOW()
        )
    </insert>


    <update id="updateMemberToken" parameterType="MemberTokenEntity">
        UPDATE member_token
        SET
            refresh_token = #{refreshToken}
          ,refresh_token_expire_datetime = #{refreshTokenExpireDatetime}
          ,delete_yn = #{deleteYn}
          ,last_update_datetime = NOW()
        WHERE  member_id = ${memberId}
    </update>

    <delete id="deleteMemberToken" parameterType="MemberTokenEntity">
        UPDATE member_token
        SET
            delete_yn = #{deleteYn}
          ,last_update_datetime = NOW()
        WHERE  member_id = ${memberId}
    </delete>

    <select id="selectMemberToken" parameterType="MemberSearch" resultType="MemberTokenEntity">
        SELECT
        t.member_id
        ,t.refresh_token
        ,t.refresh_token_expire_datetime
        ,TIMESTAMPDIFF(SECOND, NOW(), t.refresh_token_expire_datetime) AS remaining_refresh_token_seconds
        ,t.delete_yn
        ,t.reg_datetime
        ,t.last_update_datetime
        FROM member_token t
        INNER JOIN member m ON m.member_id = t.member_id
        WHERE 1 = 1
        <if test = 'memberId != null and memberId !=""'>
            AND m.member_id = ${memberId}
        </if>
        <if test = 'memberName != null and memberName !=""'>
            AND m.member_name = #{memberName}
        </if>
        <if test = 'refreshToken != null and refreshToken !=""'>
            AND t.refresh_token = #{refreshToken}
        </if>
        <if test = 'deleteYn != null and deleteYn !=""'>
            AND t.delete_yn = #{deleteYn}
        </if>
        <if test = 'email != null and email !=""'>
            AND m.email = #{email}
        </if>
    </select>


</mapper>